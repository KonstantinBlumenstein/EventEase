@page "/event/{EventId:int}"
@using EventEase.Models
@using EventEase.Services
@inject EventService EventService
@inject UserSessionService UserSession
@inject NavigationManager Navigation

<PageTitle>Event Details - EventEase</PageTitle>

@if (eventItem == null)
{
    <p><em>Loading event details...</em></p>
}
else
{
    <div class="event-details-container">
        <button class="btn-back" @onclick="GoBack">‚Üê Back to Events</button>

        <div class="event-hero">
            <img src="@eventItem.ImageUrl" alt="@eventItem.Name" />
        </div>

        <div class="event-details-content">
            <span class="event-category">@eventItem.Category</span>
            <h1>@eventItem.Name</h1>

            <div class="event-meta">
                <div class="meta-item">
                    <strong>üìÖ Date:</strong>
                    <span>@eventItem.Date.ToString("MMMM dd, yyyy - h:mm tt")</span>
                </div>
                <div class="meta-item">
                    <strong>üìç Location:</strong>
                    <span>@eventItem.Location</span>
                </div>
                <div class="meta-item">
                    <strong>üë• Capacity:</strong>
                    <span>@eventItem.RegisteredAttendees / @eventItem.Capacity</span>
                </div>
            </div>

            <div class="event-description">
                <h2>About This Event</h2>
                <p>@eventItem.Description</p>
            </div>

            <div class="registration-section">
                @if (isRegistered)
                {
                    <div class="success-message">
                        ‚úì Successfully registered for this event!
                    </div>
                    <p class="registered-info">
                        Registered as: <strong>@registrationModel.Name</strong> (@registrationModel.Email)
                    </p>
                    <a href="/event/@EventId/attendees" class="btn-view-attendees">
                        View All Attendees ‚Üí
                    </a>
                }
                else if (eventItem.RegisteredAttendees >= eventItem.Capacity)
                {
                    <div class="event-full-message">
                        <strong>Event Full</strong>
                        <p>This event has reached maximum capacity.</p>
                    </div>
                }
                else
                {
                    <h3>Register for This Event</h3>
                    <EditForm Model="@registrationModel" OnValidSubmit="HandleValidSubmit" class="registration-form">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="validation-summary" />

                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <InputText id="name" @bind-Value="registrationModel.Name" class="form-control" placeholder="Enter your full name" />
                            <ValidationMessage For="@(() => registrationModel.Name)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <InputText id="email" @bind-Value="registrationModel.Email" class="form-control" placeholder="Enter your email" />
                            <ValidationMessage For="@(() => registrationModel.Email)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number (Optional)</label>
                            <InputText id="phone" @bind-Value="registrationModel.PhoneNumber" class="form-control" placeholder="Enter your phone number" />
                            <ValidationMessage For="@(() => registrationModel.PhoneNumber)" class="validation-message" />
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="error-message">@errorMessage</div>
                        }

                        <button type="submit" class="btn-register" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Registering...</span>
                            }
                            else
                            {
                                <span>Register for Event</span>
                            }
                        </button>
                    </EditForm>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int EventId { get; set; }

    private Event? eventItem;
    private Registration registrationModel = new();
    private bool isRegistered = false;
    private bool isSubmitting = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        eventItem = await EventService.GetEventByIdAsync(EventId);
        registrationModel.EventId = EventId;

        // Check if user already registered in this session
        isRegistered = UserSession.IsRegisteredForEvent(EventId);
        if (isRegistered)
        {
            var existingReg = UserSession.GetRegistrationForEvent(EventId);
            if (existingReg != null)
            {
                registrationModel = existingReg;
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        if (eventItem == null) return;

        isSubmitting = true;
        errorMessage = null;

        // Check if email is already registered for this event
        var alreadyRegistered = await EventService.IsEmailRegisteredForEventAsync(EventId, registrationModel.Email);
        if (alreadyRegistered)
        {
            errorMessage = "This email is already registered for this event.";
            isSubmitting = false;
            return;
        }

        var success = await EventService.RegisterAttendeeAsync(registrationModel);
        if (success)
        {
            UserSession.AddRegistration(registrationModel);
            isRegistered = true;
            eventItem.RegisteredAttendees++;
        }
        else
        {
            errorMessage = "Registration failed. The event may be full.";
        }

        isSubmitting = false;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}
